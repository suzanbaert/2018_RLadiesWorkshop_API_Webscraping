---
title: "Working with web data"
author: "Suzan Baert"
date: "2018/09/27"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, "css/my-fonts.css"]
    seal: false
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

---


# Webscraping Etiquette

1. If there is a public API available, use the API and don't scrape the info

2. Always check with `robotstxt` or `polite` whether you are allowed to scrape a page

3. Build system sleeps into your API or scraping requests

4. Don't gather data you won't need

5. Keep away from gathering PII (personal identifiable) data


---

class: left, middle

background-image: url(images/laptop-background.jpg)
background-size: cover

# Part 1: API

---

# What is an API?

.center[API = Application Programming Interface  
"a set of subroutine definitions, communication protocols, and tools for building software"]

--

<br>

.center.handwritten[HUH ???]

--

<br><br>

### Examples:  
- Travel websites getting info on flight schedule and prices
- Getting fonts for your website (or this presentation) through Google Fonts API 
- Getting tweets with the hashtag #rstats via Twitter API
- ...

---

# API communication

Communication with HTTP request methods.  
Two most common ones:

--

.pull-left[
## GET requests
Asking the API for something
```
library(httr)
response <- GET(url)
content(response)
```

]

--

.pull-right[
## POST requests
Giving something to the API
```
library(httr)
response <- POST(url, body)
content(response)
```

]


---

# API output

Two general formats for API responses.
+ Both are plain text formats to exchange data
+ Most API's these days are JSON


.pull-left[
### JSON
Javascript Object Notation

```
{"employees":[
    {"firstName":"John", "lastName":"Doe"},
    {"firstName":"Anna", "lastName":"Smith"},
    {"firstName":"Peter", "lastName":"Jones"}
]}
```
]

--

.pull-right[
### XML
Extensible Markup Language

```
<employees>
    <employee>
        <firstName>John</firstName> 
        <lastName>Doe</lastName>
    </employee>
    <employee>
        <firstName>Anna</firstName> 
        <lastName>Smith</lastName>
    </employee>
    <employee>
        <firstName>Peter</firstName> 
        <lastName>Jones</lastName>
    </employee>
</employees>
```
]

---

# A quick intro to JSON

Two basic forms:
+ JSON object: `{"key": "value"}`
+ JSON array: `[1, 2, 3]` or `["a", "b", "c"]`

--

Building hierarchies
+ The value of a JSON object can be another JSON object or array
+ The values in a JSON array can be another JSON object or array

--

For R users:
+ JSON object ~ named value
+ JSON array ~ named vector

---

# A quick intro to JSON

`jsonlite::prettify()` to make a more human readable JSON

```{r}
library(jsonlite)

json_object <- '{"organization" : "R-Ladies", "chapter": "Brussels", "start_year": 2017, "active": true, "organizers": ["Marlene", "Huong", "Suzan"]}'
prettify(json_object)
```


---

# A quick intro to JSON

`jsonlite::fromJSON()` to parse JSON to R


```{r}
library(jsonlite)
fromJSON(json_object)
```

---

background-image: url(images/API_workflow.png)
background-position: 50% 60%
background-size: 1000px

# Making API requests

Process:




---

# Easy example: ISS position

![](images/API1_ISS.png)

---

background-image: url(images/API_workflow_icon1.png)
background-position: 100% 0%
background-size: 200px


# Easy example: ISS position

Step 1: Preparation:

```{r cache=TRUE}
url <- "http://api.open-notify.org/iss-now.json"
```


---

background-image: url(images/API_workflow_icon2.png)
background-position: 100% 0%
background-size: 200px

# Easy example: ISS position


Step 2: GET request:
```{r cache=TRUE}
library(httr)
response_iss <- GET(url)
response_iss
```

--

*Status codes:*
+ 200: OK
+ 400-499: your code is missing something
+ 500-599: something is off on our end


---

background-image: url(images/API_workflow_icon3.png)
background-position: 100% 0%
background-size: 200px

# Easy example: ISS position

Step 3: Extract and parse the response

```{r cache = TRUE}
content_iss <- content(response_iss)
content_iss
```


---

background-image: url(images/API_workflow_icon3.png)
background-position: 100% 0%
background-size: 200px

# Easy example: ISS position

Step 4: Data wrangling in R

```{r cache = TRUE}
ISS_position <- data.frame(
  time = content_iss$timestamp,
  lat = content_iss$iss_position$latitude,
  long = content_iss$iss_position$longitude)

ISS_position

```

---

background-image: url(images/API_workflow_R.png)
background-position: 50% 60%
background-size: 1000px

# Making API requests

Process:




---

background-image: url(images/API_workflow_icon1.png)
background-position: 100% 0%
background-size: 200px


# Prepare your request: URL-building


Read the documentation: every API is different

+ Directory based URLs: `url/api/directory1/directory2`

+ Parameter based URLs: `url/api?param1=value1&param2=value2`

+ Or a combination of both: `url/api/directory1?param1=value`

--

### Examples:

Github: `https://api.github.com/repos/vmg/redcarpet/issues?state=closed`

Star Wars API: `https://swapi.co/api/planets`

Game of Thrones API: `https://www.anapioficeandfire.com/api/characters?page=1&pageSize=10`


---

background-image: url(images/API_workflow_icon1.png)
background-position: 100% 0%
background-size: 200px


# Prepare your request: URL-building

Directory based urls:
+ Pasting full URL: `url <- "http://api.blabla.com/bla/bla"`
+ Iterative: paste0

```{r}
dir <- "directory1"
url <- paste("base_url", dir, sep = "/")
url
```


Parameter based urls:

```{r}
query_params <- list(param1 = "value1", param2 = "value2")
```

---

background-image: url(images/API_workflow_icon1.png)
background-position: 100% 0%
background-size: 200px


# Prepare your request: Authentication

Different types of authentication exists: 
+ username/password `via authenticate()`
+ OAuth 1.0
+ OAuth 2.0

How to get access? 
+ Follow the documentation

Example: authenication for Twitter API   [https://rtweet.info/articles/auth.html](https://rtweet.info/articles/auth.html)

---

background-image: url(images/API_workflow_icon2.png)
background-position: 100% 0%
background-size: 200px


# Step 2: GET request

Basic structure:

```
library(httr)
response <- GET(url, 
                query = query_params,
                authenticate("username", "password"))
```
+ URL: base URL or full URL assembled before
+ optional: query with a list of query paramaters
+ optional: authenticate


---

background-image: url(images/API_workflow_icon3.png)
background-position: 100% 0%
background-size: 200px


# Step 3: Extract and parse the response

```
library(httr)
content <- content(response)
```

By default, httr::content() automatically parses to R
+ if JSON: using jsonlite::fromJSON()
+ if XML: using xml2::read_xml()

Alternative options:
+ `content(response, as = "text")`: extracts without parsing


---

background-image: url(images/API_workflow_icon4.png)
background-position: 100% 0%
background-size: 200px


# Step 4: Data wranging in R

Use all your list tools to get your data in the shape you need it:
- purrr
- dplyr
- rlist
- ...


---

# Repeated API calls

+ Wrap your code in a function
+ Build a sys.Sleep() between iterations!



---

# Your turn:

an API of Ice and Fire: www.anapioficeandfire.com

+ Get the info on all the books
+ Extract the POV (point of view characters) from book 1
+ Ask the API for info on all pov characters from book 1



---

# Your turn: solution

Getting the info on all books

```{r}
library(httr)
url <- "https://www.anapioficeandfire.com/api/books"
response_books <- GET(url)
content_books <- content(response_books)

#look into the book 
str(content_books, max.level = 2)
```


---


# Your turn: solution

Getting the info on all books

```{r cache = TRUE}
library(httr)
url <- "https://www.anapioficeandfire.com/api/books"
response_books <- GET(url)
content_books <- content(response_books)

#look into the book 
str(content_books, max.level = 2)
```


---

# Your turn: solution

Extract the POV (point of view characters) from book 1


```{r cache = TRUE}
content_book1 <- content_books[[1]]
book1_pov <- content_book1$povCharacters
book1_pov <- unlist(book1_pov)
book1_pov
```


---

# Your turn: solution

Call the API for info on first character

```{r cache = TRUE}
url1 <- book1_pov[1]
response <- GET(url1)
content <- content(response)

data.frame(name = content$name,
  gender = content$gender,
  culture = content$culture,
  born = content$born,
  died = content$died)
```

---

# Your turn: solution

Wrap it inside a function:

```{r}
get_pov_info <- function(url) {
  response <- GET(url)
  content <- content(response)
  
  df <- data.frame(
    name = content$name,
    gender = content$gender,
    culture = content$culture,
    born = content$born,
    died = content$died, stringsAsFactors = FALSE)
  
  Sys.sleep(1)
  
  df
}
```


---

# Your turn: solution

```{r eval = FALSE}
all_pov_info <- purrr::map_df(book1_pov, get_pov_info)
all_pov_info
```

```{r echo = FALSE}
readRDS("data/all_pov_info.RDS")
```


---

# Final word in APIs...

<br><br><br>

.center[
## Make you life easy: 
## If a package already exists: use it!]

---